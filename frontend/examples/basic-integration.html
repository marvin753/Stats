<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Basic Integration Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #5568d3; }
    .output {
      margin-top: 10px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Basic Integration Example</h1>
    <p>This example demonstrates the basic usage of all security modules.</p>

    <!-- Example 1: Configuration -->
    <div class="section">
      <h2>1. Configuration</h2>
      <button onclick="testConfig()">Test Config</button>
      <div id="config-output" class="output"></div>
    </div>

    <!-- Example 2: URL Validation -->
    <div class="section">
      <h2>2. URL Validation</h2>
      <input type="text" id="url-input" placeholder="Enter URL" style="width: 100%; padding: 8px; margin-bottom: 10px;">
      <button onclick="testUrlValidation()">Validate URL</button>
      <div id="url-output" class="output"></div>
    </div>

    <!-- Example 3: Error Handling -->
    <div class="section">
      <h2>3. Error Handling</h2>
      <button onclick="testErrorHandling()">Test Errors</button>
      <div id="error-output" class="output"></div>
    </div>

    <!-- Example 4: Rate Limiting -->
    <div class="section">
      <h2>4. Rate Limiting</h2>
      <button onclick="testRateLimiting()">Check Rate Limits</button>
      <div id="rate-output" class="output"></div>
    </div>

    <!-- Example 5: API Integration -->
    <div class="section">
      <h2>5. API Integration</h2>
      <input type="password" id="api-key-input" placeholder="Enter API Key" style="width: 100%; padding: 8px; margin-bottom: 10px;">
      <button onclick="setApiKey()">Set API Key</button>
      <button onclick="testHealthCheck()">Health Check</button>
      <div id="api-output" class="output"></div>
    </div>
  </div>

  <script type="module">
    import config from '../config.js';
    import apiClient from '../api-client.js';
    import ErrorHandler from '../error-handler.js';
    import UrlValidator from '../url-validator.js';

    // Make modules globally available for onclick handlers
    window.config = config;
    window.apiClient = apiClient;
    window.ErrorHandler = ErrorHandler;
    window.UrlValidator = UrlValidator;

    // Test functions
    window.testConfig = function() {
      const output = document.getElementById('config-output');
      const summary = config.getSummary();
      output.textContent = JSON.stringify(summary, null, 2);
    };

    window.testUrlValidation = function() {
      const input = document.getElementById('url-input');
      const output = document.getElementById('url-output');
      const url = input.value || 'https://example.com/quiz';

      const result = UrlValidator.validate(url);

      output.textContent = `URL: ${url}\n` +
        `Valid: ${result.isValid}\n` +
        `Errors: ${result.errors.length}\n` +
        `Warnings: ${result.warnings.length}\n\n` +
        JSON.stringify(result, null, 2);
    };

    window.testErrorHandling = function() {
      const output = document.getElementById('error-output');
      const errors = [
        new Error('AUTH_NO_KEY'),
        new Error('RATE_LIMIT_EXCEEDED:30'),
        new Error('NETWORK_ERROR'),
        new Error('Not allowed by CORS policy')
      ];

      const results = errors.map(error => {
        const parsed = ErrorHandler.parseError(error);
        return {
          type: parsed.type,
          userMessage: parsed.userMessage,
          retryable: parsed.retryable,
          retryAfter: parsed.retryAfter
        };
      });

      output.textContent = JSON.stringify(results, null, 2);
    };

    window.testRateLimiting = function() {
      const output = document.getElementById('rate-output');
      const status = apiClient.getRateLimitStatus();

      output.textContent = `OpenAI Rate Limit:\n` +
        `  Used: ${status.openai.used}/${status.openai.limit}\n` +
        `  Remaining: ${status.openai.remaining}\n` +
        `  Reset in: ${Math.ceil(status.openai.resetIn / 1000)}s\n` +
        `  Near limit: ${status.openai.isNearLimit}\n\n` +
        `General Rate Limit:\n` +
        `  Used: ${status.general.used}/${status.general.limit}\n` +
        `  Remaining: ${status.general.remaining}\n` +
        `  Reset in: ${Math.ceil(status.general.resetIn / 1000)}s`;
    };

    window.setApiKey = function() {
      const input = document.getElementById('api-key-input');
      const output = document.getElementById('api-output');
      const key = input.value;

      if (config.setApiKey(key)) {
        output.textContent = '✓ API key saved successfully';
        output.style.color = 'green';
      } else {
        output.textContent = '✗ Invalid API key format';
        output.style.color = 'red';
      }
    };

    window.testHealthCheck = async function() {
      const output = document.getElementById('api-output');

      if (!config.hasApiKey()) {
        output.textContent = '✗ Please set API key first';
        output.style.color = 'red';
        return;
      }

      try {
        output.textContent = 'Checking...';
        output.style.color = 'black';

        const health = await apiClient.healthCheck();

        output.textContent = 'Health Check Result:\n' +
          JSON.stringify(health, null, 2);
        output.style.color = 'green';
      } catch (error) {
        const parsed = ErrorHandler.parseError(error);
        output.textContent = `Error: ${parsed.userMessage}\n\n` +
          `Type: ${parsed.type}\n` +
          `Code: ${parsed.code}`;
        output.style.color = 'red';
      }
    };
  </script>
</body>
</html>
